# 新チャンク配置ロジック総覧

> **目的**: 迷路チャンクを既存構造と衝突させず、先々に伸ばせる位置へ確実に配置するための手順をまとめる。

---

## 1. 基本ルール

### 1.1 置く向きは **ドア面の真正面**
- 通過した出口ドアがある壁面の外側に新チャンクを設置。
- 方角は N/E/S/W の4方向で、ドアが開いた向きをそのまま採用。

```
[旧チャンク]□□□□□□□□🚪┼   ← 共有壁 (┼)
             □□□□□□□□□
             □  新チャンク □
             □□□□□□□□□
```

### 1.2 **入口と外周壁は共有・再利用**
- 既存チャンクと新チャンクは外周1マスの壁を真上から重ねて密着させる。
- 共有部分の壁ブロックを両チャンクで床に置き換え、シームレスな通路を作る。
- 壁厚が2枚にならず衝突判定が一箇所で済む。
- 入口直後の1マスも床に変えるとプレイヤーが確実に進入できる。
- 出口が四隅に接しないよう、必要に応じて1マスずらす。

---

## 2. 配置アルゴリズム
1. 新チャンクを置きたい **出口位置の隣マス** を辺として含む最大の長方形領域を計算する。
   - 障害物や既存チャンクにぶつかるまで上下左右に範囲を広げるだけなので、候補チャンクのサイズ判定は省略可能。
2. その長方形の内部で、チャンク候補のサイズと位置、出口扉の位置を仮決定する。
3. 仮決定した出口から同じロジックで次チャンク用の最大長方形を求める。
   - ここで **同じサイズのチャンク** が収まるなら現在の配置を確定する。
4. 収まらない場合は出口の方角や位置、チャンクのサイズ・位置を変更して再帰的に探索する。
5. すべてのパターンを試しても決定できないときは、原因調査のため **ゲームを停止** してデバッグ情報を表示する。

### メモ
- 長方形計算はシンプルな走査でよく、候補サイズに合わせた検証は後から行う。
- 再帰探索は深さが増えすぎないよう、サイズや向きの組み合わせ数を適度に制限する。

---

## 3. フロー概略
```
最大長方形計算 → 仮チャンク配置 → 次チャンクも置ける?  → 確定
                                               └→ NG: 再帰探索
すべて失敗 → ゲーム停止(デバッグ)
```

---

© 2025 Dainei Makino
