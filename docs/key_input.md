# ハイスピードおつかいローグ – 入力・操作仕様（PC 版）

> **目的** : キーボードでの操作方法と、タイルベースの移動ロジックを誰でも理解・実装できるようにまとめる。

---

## 1. 基本方針

- **タイルベース移動★** : 1 回の入力で **32×32 px**（=1 タイル）だけ移動する。
- **4 方向限定** : 斜め移動・滑る移動は無し。上下左右のみ。
- **アニメーション付き** : 実際の座標は補間アニメで滑らかに動かすが、**論理座標**は一瞬で次タイルへ更新する。

> タイルベース移動とは「キャラクターがマス目を 1 つずつカクッと進む仕組み」。論理座標と実座標を分けることで当たり判定がシンプルになる。

---

## 2. キー割り当て

| アクション        | キー              | 代替キー | 備考                  |
| ------------ | --------------- | ---- | ------------------- |
| 移動・上         | **W** / ↑ Arrow | —    | 押した瞬間に 1 タイル上へキュー登録 |
| 移動・下         | **S** / ↓ Arrow | —    | 同上                  |
| 移動・左         | **A** / ← Arrow | —    | 同上                  |
| 移動・右         | **D** / → Arrow | —    | 同上                  |
| ポーズ / メニュー開閉 | **Esc**         | P    | 一時停止・設定変更           |
| ミュート切替       | M               | —    | BGM / SE 同時ミュート     |

> **同時押し時の優先** : 最初に押されたキーを処理し、残りは0.2秒だけ入力バッファに保持され、元のキーが離された場合バッファのキーを1つだけ処理する。

---

## 3. 入力イベント → 移動完了までのフロー

```
KeyDown (→) ─→ InputBuffer.push('E')
                  │
Update() 60fps ──┴─→ if(!isMoving) consume() → setTargetTile
                               │      │
                               │  Tween.start(fromPos → toPos, 0.12s)
                               │      │
                              Tween.onComplete → isMoving=false
```

1. **KeyDown** : `keydown` イベントで方向キーを検出し、`InputBuffer` 配列に追加。
2. **Update ループ** : フレームごとに
   - `isMoving` が **false** ならバッファ先頭を取り出し、
   - ターゲットタイル `(tx,ty)` を計算。
   - 壁タイルなら入力破棄、床タイルなら `isMoving=true` にして Tween★ 開始。
3. **Tween 完了** : 実座標がターゲットに到達したら `isMoving=false` に戻り、次の入力を処理。

> Tween … 位置やスケールを時間補間で滑らかに変える技。Phaser では `this.tweens.add({ … })` を使う。

---

## 4. 移動ロジックの詳細ルール

- **押しっぱなし許可** : キーを押しっぱなしにするとそのまま進む。
- **バッファ上限 4** : 連打しても 4 ステップ先までに制限し、操作遅延を防ぐ。
- **壁チェック** : 目標タイルが壁 (`tileId===0`) なら入力を即破棄し、足踏みアニメを再生。
- **移動速度** : 基本 0.12 秒 / マス。スピードアップ時は 0.08 秒 / マス。

---

## 5. アニメーション管理

| 状態      | フレーム | 再生 FPS | 備考          |
| ------- | ---- | ------ | ----------- |
| 待機      | 2 f  | 4 fps  | 呼吸ゆらぎ       |
| 走り (各向) | 2 f  | 8 fps  | Tween 中のみ再生 |
| パワーアップ  | 色替え  | —      | `tint` 周期変化 |

Sprite は `` 経由で状態遷移(`setState('run-left')`)を行う。


## 6. エッジケースと対策

| ケース                    | 仕様                              |
| ---------------------- | ------------------------------- |
| 同フレームに上下キー同時押し         | 先に押された方を採用。もう一方はバッファへ           |
| エミュレーター等で 100 ms 以下の連打 | バッファ上限 4 で入力溢れを防止               |
| FPS 低下 (30 fps 未満)     | Tween 時間を **固定秒数** で管理するため速度は一定 |
| ポーズ中のキー入力              | `InputBuffer` をクリアして誤作動防止       |

---

## 7. 用語早見表

| 用語         | 意味                  | 一言で言うと…        |
| ---------- | ------------------- | -------------- |
| タイルベース移動   | マス単位で位置を管理          | 将棋の駒のように動く方式   |
| バッファ       | 入力の待ち行列             | まとめて順番に処理する箱   |
| Tween      | 補間アニメ               | 点A→点Bを滑らかに動く技法 |
| 論理座標 / 実座標 | ゲーム内部の数値 / 画面表示用の座標 | 衝突判定と見た目を分離    |

---

© 2025 Dainei Makino. 本資料はプロジェクトメンバー・教育目的での転載を許可します。

