# ハイスピードおつかいローグ – 迷路生成仕様

> **目的** : 迷路がどのように作られ、どのように連結・拡張されるかを、プログラマー以外でも理解できるようにまとめる。高校生が読んでも分かるよう専門用語には★印で簡単な注釈を付けた。

---

## 1. 迷路チャンクとは？

- **チャンク (chunk)★** … ゲーム内で一度に表示される **部屋サイズの迷路ブロック** のこと。基本は **13×13 タイル** だが、幅だけ狭い **5×13～9×13** などの長方形バリエーションも存在する。
- **タイル★** … 迷路を構成する最小マス目（1 マス＝16×16 ピクセル）。
- **外周は壁固定** … チャンクの一番外側 1 マスは必ず壁なので、実際に歩けるのは 10×10 マス。

```
  □ = 壁   · = 床
  13×13   外周は全部 □
  □□□□□□□□□□□□□
  □···········□
  □···········□  ← 中身を掘って迷路を作る
  …
  □□□□□□□□□□□□□
```

---

## 2. 迷路の掘りかた – Depth‑First Search (DFS)★

1. すべて壁で埋まった状態からスタート。
2. スタック（「やることメモ」）に現在位置を入れる。
3. 未訪問の隣マスがあればランダムに 1 つ選び、 **そこまでの壁を壊して進む**。
4. 行き止まりになったらメモを 1 つ戻って別の方向へ。
5. メモが空になるまで繰り返すと、すべてのマスが 1 本の道でつながった迷路が完成。
6. ランダムな位置、個数のマス(外周以外)に迂回路となる床で上書き

> DFS は「深さ優先探索」の略で、**一直線に深く進んでから戻る** 探索方法。コードは 20～30 行で書けるお手軽アルゴリズム。

---

## 3. タイルの種類と数値割り当て

| 数値 | 表示 | 説明          |
| -- | -- | ----------- |
| 0  | □  | 壁 (Wall)    |
| 1  | ·  | 床 (Floor)   |
| 2  | 🔑 | 宝箱 (鍵入り)    |
| 3  | 🚪 | 出口ドア (鍵付き)  |
| 4  | ✨  | アイテム宝箱（色違い） |
| 5  | ◼︎ | 特殊チャンク接続口   |
| 6  | 🚪 | 銀色の扉 (鍵は消費しない) |
| 7  | 🛢 | 酸素ボンベ (O2回復)。5チャンク目以降は10%の確率で上級酸素ボンベに変化し、O2が8回復 |

内部的には **TypedArray** に数字だけ入れて軽量化する。

---

## 4. 宝箱と扉のルール

- **宝箱** はチャンク内に 1 つ。必ずプレイヤーの初期位置から到達可能。
- **出口ドア** は外周のどこか 1 辺に 1 つ。 **プレイヤーが入ってきた壁以外** の面に生成し、一本道にならないようにする。
- プレイヤーが宝箱で **鍵** を拾うとその場で出口ドアが開く。
- 2チャンク目以降、南北か東西の両側が通路になっている壁を優先して **銀色の扉** に置き換える。該当箇所がない場合は生成されない。
- 銀色の扉は同じチャンク内で鍵を取得した瞬間に開き、以降は開いた状態が維持される。

図（例：北から入った場合は東西南いずれかに扉）

```
    □□□□□□□□□
 N→ □·······🚪□
    □··🔑·····□
    □□□□□□□□□
```

---

## 5. 新チャンクの配置と衝突チェック


## 6. チャンクの大きさと難易度テーブル

| ゲーム進行 (クリア数) | 候補チャンク                  | 出現率  | 特記事項      |
| ------------ | ----------------------- | ---- | --------- |
| 0～4          | 13×13 (基本)              | 100% | チュートリアル   |
| 5～9          | 12×24 (横長) / 24×12 (縦長) | 50%  | 宝箱 2 つに増加 |
| 10～14        | 30×30 (不定形)             | 30%  | 行き止まり増量   |
| 15～          | Irregular+橋付き           | 30%  | 特殊ギミック解禁  |

テーブルは JSON / CSV で外部化し、**ゲーム開始時に読み込む**。

### 実装版テーブル（2025 現在）
現在の簡易実装では下記のように段階ごとの迷路サイズを管理している。

| ステージ | 迷路サイズ候補 |
| ------- | -------------- |
| 1       | 13×13          |
| 2～     | 9×9 / 11×11 / 13×13 / 5×13 / 7×13 / 9×13 |


---

## 7. 生成アルゴリズム全体フロー

1. **CreateChunk(seed, size)**
   - DFS で迷路を掘る
   - 宝箱配置 → 扉候補抽出
   - BFS★ で宝箱→扉が到達可能か検査 (NG なら作り直し)
2. **PlaceChunk(worldX, worldY)**
   - 既存チャンクと衝突しないか判定
   - OK → 配置し外周共有 / NG → リトライ or 特殊ミニチャンク
3. **UpdateDifficulty()** : クリア数ごとにテーブル行を進める

> BFS … Breadth‑First Search。「浅い順」に広がる探索で最短距離を測れる。

---

## 8. データ構造 (コード例・擬似)

```ts
interface MazeChunk {
  width: number;               // 奇数タイル数
  height: number;              // 奇数タイル数
  tiles: Uint8Array;           // width*height 長さ
  door: { dir:'N'|'E'|'S'|'W', x:number, y:number };
  chest: { x:number, y:number };
  seed: string;                // 再現用シード
}

const world: Record<string, MazeChunk> = {}; // "x,y" をキーに格納
```

---

## 9. デバッグ機能

- **占有マップ表示** : チャンク配置をミニマップで確認
- **seed ログ** : バグ報告時に同じ迷路を再生成できる
- **生成リトライ回数カウンタ** : 無限ループ検知

---

## 10. 用語まとめ

| 用語   | 意味                 | 一言で言うと…     |
| ---- | ------------------ | ----------- |
| タイル  | 迷路を作る 1 マス         | レゴブロック 1 つ分 |
| チャンク | タイルを並べた部屋サイズのデータ | ゲームが描画する単位  |
| DFS  | 深さ優先探索。一直線に掘って戻る   | 細長い迷路ができやすい |
| BFS  | 幅優先探索。広がりながら調べる    | 最短距離を測るのに便利 |
| AABB | 四角形の当たり判定          | 衝突チェックの定番   |
| シード  | 乱数のタネ。文字列や数値       | 同じシード→同じ迷路  |

---

© 2025 Dainei Makino. 本資料はプロジェクトメンバー・教育目的での転載を許可します。

