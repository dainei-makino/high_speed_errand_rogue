# ハイスピードおつかいローグ – 迷路生成仕様

> **目的** : 迷路がどのように作られ、どのように連結・拡張されるかを、プログラマー以外でも理解できるようにまとめる。高校生が読んでも分かるよう専門用語には★印で簡単な注釈を付けた。

---

## 1. 迷路チャンクとは？

- **チャンク (chunk)★** … ゲーム内で一度に表示される **部屋サイズの迷路ブロック** のこと。基本は **13×13 タイル**。
- **タイル★** … 迷路を構成する最小マス目（1 マス＝16×16 ピクセル）。
- **外周は壁固定** … チャンクの一番外側 1 マスは必ず壁なので、実際に歩けるのは 10×10 マス。

```
  □ = 壁   · = 床
  13×13   外周は全部 □
  □□□□□□□□□□□□□
  □···········□
  □···········□  ← 中身を掘って迷路を作る
  …
  □□□□□□□□□□□□□
```

---

## 2. 迷路の掘りかた – Depth‑First Search (DFS)★

1. すべて壁で埋まった状態からスタート。
2. スタック（「やることメモ」）に現在位置を入れる。
3. 未訪問の隣マスがあればランダムに 1 つ選び、 **そこまでの壁を壊して進む**。
4. 行き止まりになったらメモを 1 つ戻って別の方向へ。
5. メモが空になるまで繰り返すと、すべてのマスが 1 本の道でつながった迷路が完成。
6. ランダムな位置、個数のマス(外周以外)に迂回路となる床で上書き

> DFS は「深さ優先探索」の略で、**一直線に深く進んでから戻る** 探索方法。コードは 20～30 行で書けるお手軽アルゴリズム。

---

## 3. タイルの種類と数値割り当て

| 数値 | 表示 | 説明          |
| -- | -- | ----------- |
| 0  | □  | 壁 (Wall)    |
| 1  | ·  | 床 (Floor)   |
| 2  | 🔑 | 宝箱 (鍵入り)    |
| 3  | 🚪 | 出口ドア (鍵付き)  |
| 4  | ✨  | アイテム宝箱（色違い） |
| 5  | ◼︎ | 特殊チャンク接続口   |

内部的には **TypedArray** に数字だけ入れて軽量化する。

---

## 4. 宝箱と扉のルール

- **宝箱** はチャンク内に 1 つ。必ずプレイヤーの初期位置から到達可能。
- **出口ドア** は外周のどこか 1 辺に 1 つ。 **プレイヤーが入ってきた壁以外** の面に生成し、一本道にならないようにする。
- プレイヤーが宝箱で **鍵** を拾うとドアを開けられる。

図（例：北から入った場合は東西南いずれかに扉）

```
    □□□□□□□□□
 N→ □·······🚪□
    □··🔑·····□
    □□□□□□□□□
```

---

## 5. 新チャンクの配置と衝突チェック

1. ドアが付いた外周マスの“外側”に候補位置を決める。
2. その位置に **13×13** など目的サイズの枠を置き、
   - 既存チャンクと **重ならないか** (AABB★ 衝突判定)
   - 枠の外にあるか (ワールド境界外) を確認。
3. OK なら生成。ダメなら **3 回までリトライ** し、それでも失敗したら **特殊ミニチャンク** (5×5 の橋やトンネル) で無理やり接続。
4. 接続が決まったら外周の共有壁を削除し、道をつなぐ。

> AABB … Axis‑Aligned Bounding Box。要するに「四角同士が重なるか」を調べる単純な方法。

---

## 6. チャンクの大きさと難易度テーブル

| ゲーム進行 (クリア数) | 候補チャンク                  | 出現率  | 特記事項      |
| ------------ | ----------------------- | ---- | --------- |
| 0～4          | 13×13 (基本)              | 100% | チュートリアル   |
| 5～9          | 12×24 (横長) / 24×12 (縦長) | 50%  | 宝箱 2 つに増加 |
| 10～14        | 30×30 (不定形)             | 30%  | 行き止まり増量   |
| 15～          | Irregular+橋付き           | 30%  | 特殊ギミック解禁  |

テーブルは JSON / CSV で外部化し、**ゲーム開始時に読み込む**。

---

## 7. 生成アルゴリズム全体フロー

1. **CreateChunk(seed, size)**
   - DFS で迷路を掘る
   - 宝箱配置 → 扉候補抽出
   - BFS★ で宝箱→扉が到達可能か検査 (NG なら作り直し)
2. **PlaceChunk(worldX, worldY)**
   - 既存チャンクと衝突しないか判定
   - OK → 配置し外周共有 / NG → リトライ or 特殊ミニチャンク
3. **UpdateDifficulty()** : クリア数ごとにテーブル行を進める

> BFS … Breadth‑First Search。「浅い順」に広がる探索で最短距離を測れる。

---

## 8. データ構造 (コード例・擬似)

```ts
interface MazeChunk {
  size: 13 | 21 | 31 | 41;          // 一辺のタイル数（いずれも奇数）
  tiles: Uint8Array;           // size*size 長さ
  door: { dir:'N'|'E'|'S'|'W', x:number, y:number };
  chest: { x:number, y:number };
  seed: string;                // 再現用シード
}

const world: Record<string, MazeChunk> = {}; // "x,y" をキーに格納
```

---

## 9. デバッグ機能

- **占有マップ表示** : チャンク配置をミニマップで確認
- **seed ログ** : バグ報告時に同じ迷路を再生成できる
- **生成リトライ回数カウンタ** : 無限ループ検知

---

## 10. 用語まとめ

| 用語   | 意味                 | 一言で言うと…     |
| ---- | ------------------ | ----------- |
| タイル  | 迷路を作る 1 マス         | レゴブロック 1 つ分 |
| チャンク | タイルを 13×13 個並べた大部屋 | ゲームが描画する単位  |
| DFS  | 深さ優先探索。一直線に掘って戻る   | 細長い迷路ができやすい |
| BFS  | 幅優先探索。広がりながら調べる    | 最短距離を測るのに便利 |
| AABB | 四角形の当たり判定          | 衝突チェックの定番   |
| シード  | 乱数のタネ。文字列や数値       | 同じシード→同じ迷路  |

---

© 2025 Dainei Makino. 本資料はプロジェクトメンバー・教育目的での転載を許可します。

