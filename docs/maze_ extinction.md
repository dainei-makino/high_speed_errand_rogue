# ハイスピードおつかいローグ – 迷路消滅仕様

> **目的** : 画面に残った古い迷路チャンクが「色あせ → 蒸発する」挙動を正確に定義し、プログラマー・デザイナー・デバッガーが一目で理解できるようにする。

---

## 1. チャンク寿命モデル

以前は時間経過でチャンクが消える **TTL 方式** を採用していたが、現在は「生成順より 2 チャンク先に主人公が到達したら即消滅する」システムに変更された。FadeIn/FadeOut の演出時間は固定で、寿命はプレイヤーの進行度に依存する。


---

## 2. 色あせアルゴリズム (HSL→α二段式)

```
0s         Bloom              FadeOut            TTL
│───────────│──────────────────────────│
Lightness 50% → ★80%          α 1.0 → 0.0
        (発光)              (徐々に消える)
```

1. **Normal Phase** (生成～TTL−BloomPhase−FadeOut)
   - `lightness` = **50 %** (基準)。
   - `alpha` = **1.0**。
2. **Bloom Phase** (TTL−BloomPhase～TTL−FadeOut)
   - `lightness` を **50→80 %** へ線形増加。
   - `alpha` は 1.0 のまま。
3. **FadeOut Phase** (TTL−FadeOut～TTL)
   - `lightness` は 80 % を維持。
   - `alpha` を **1.0→0.0** へ線形減少。
4. **Destroy**
   - `alpha` が 0.0 になったチャンクはオブジェクトプールに返却し、GC★ を抑える。

> HSL★ … 色を「色相(H), 彩度(S), 明度(L)」で表す方式。 GC★ … ガーベジコレクション。不要メモリを自動で回収する仕組み。

---

## 3. ゲームプレイへの影響

| タイミング          | プレイヤーへのフィードバック                                          |
| -------------- | ------------------------------------------------------- |
| BloomPhase 開始  | 画面縁を薄赤に 1 フレーム点滅 / 警告 SE                                |
| FadeOut Phase中 | チャンク床に半透明マスク、歩行 SE をくぐもらせる                              |
| 消滅判定           | プレイヤーの足元座標が `alpha<0.2` かつ `colliderOn` なら **GameOver** |

---

## 4. パフォーマンスとメモリ

1. **オブジェクトプール** : `destroy()` では DisplayObject を *非表示で待機* させ、再利用。
2. **LOD★** : カメラ外にあるチャンクは `update()` をスキップ。
3. **スマホ向け軽量化** : FadeOut 粒子演出を `qualityFactor` で 0.5 倍に。

> LOD … Level of Detail。画面外や遠景では処理を粗くする手法。

---

## 5. デバッグ表示

- **チャンク年齢** : `age.toFixed(1)` をタイル中央に HUD 表示。
- **TTL タイマーリング** : UI サークルゲージで視覚化。
- **フェーズ色** : Normal=青枠 / Bloom=黄枠 / FadeOut=赤枠 と枠線を自動変更 (デバッグモード時のみ)。

---

## 6. 用語早見表

| 用語       | 意味                 | 一言で言うと…       |
| -------- | ------------------ | ------------- |
| TTL      | Time‑To‑Live       | 寿命 (秒)        |
| HSL      | 色相・彩度・明度           | 色を数値で操作しやすい方式 |
| α (アルファ) | 透明度 0〜1            | 0=完全透明 1=不透明  |
| Bloom    | 発光エフェクト            | 消える前に光らせる技法   |
| GC       | Garbage Collection | メモリ自動回収       |

---

© 2025 Dainei Makino. 本資料はプロジェクトメンバー・教育目的での転載を許可します。

